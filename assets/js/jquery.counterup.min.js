(function($) {
    "use strict";

    $.fn.counterUp = function(options) {
        var settings = $.extend({
            time: 400,   // total duration
            delay: 10    // delay between counts
        }, options);

        return this.each(function() {
            var $this = $(this);

            var counterFunc = function() {
                var nums = [];
                var totalSteps = settings.time / settings.delay;
                var text = $this.text().trim();

                // Check if text ends with '+'
                var hasPlus = text.endsWith("+");
                if (hasPlus) text = text.slice(0, -1); // remove '+' for calculation

                var hasComma = /[0-9]+,[0-9]+/.test(text);
                text = text.replace(/,/g, "");

                var isInt = /^[0-9]+$/.test(text);
                var isFloat = /^[0-9]+\.[0-9]+$/.test(text);
                var decimals = isFloat ? (text.split(".")[1] || []).length : 0;

                for (var i = totalSteps; i >= 1; i--) {
                    var val = parseInt(text / totalSteps * i);
                    if (isFloat) val = parseFloat(text / totalSteps * i).toFixed(decimals);

                    if (hasComma) {
                        while (/(\d+)(\d{3})/.test(val.toString())) {
                            val = val.toString().replace(/(\d+)(\d{3})/, "$1,$2");
                        }
                    }

                    // Always append '+' if the original text had it
                    if (hasPlus) val = val + "+";

                    nums.unshift(val);
                }

                $this.data("counterup-nums", nums);
                $this.text("0" + (hasPlus ? "+" : ""));

                var run = function() {
                    $this.text($this.data("counterup-nums").shift());
                    if ($this.data("counterup-nums").length) {
                        setTimeout($this.data("counterup-func"), settings.delay);
                    } else {
                        $this.removeData("counterup-nums");
                        $this.removeData("counterup-func");
                    }
                };

                $this.data("counterup-func", run);
                setTimeout($this.data("counterup-func"), settings.delay);
            };

            // Trigger counter when element is visible
            $this.waypoint(counterFunc, { offset: "100%", triggerOnce: true });
        });
    };
})(jQuery);
